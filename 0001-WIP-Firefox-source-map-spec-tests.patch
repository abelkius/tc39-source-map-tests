From 763e1e0ce78d6dcd3b94e428b9f399b6c92cdf34 Mon Sep 17 00:00:00 2001
From: Asumu Takikawa <asumu@igalia.com>
Date: Tue, 27 Feb 2024 18:22:45 -0800
Subject: [PATCH] WIP Firefox source map spec tests

---
 .../test/browser/browser.toml                 |  2 +
 .../test/browser/browser_spec-source-map.js   | 44 +++++++++++++++++++
 .../fixtures/source-map-spec-tests.json       | 28 ++++++++++++
 .../browser/fixtures/version-not-a-number.js  |  1 +
 .../fixtures/version-not-a-number.js.map      |  6 +++
 .../test/browser/fixtures/version-numbers.js  |  6 +++
 .../test/browser/fixtures/version-too-high.js |  1 +
 .../browser/fixtures/version-too-high.js.map  |  6 +++
 .../test/browser/fixtures/version-too-low.js  |  1 +
 .../browser/fixtures/version-too-low.js.map   |  6 +++
 .../test/browser/fixtures/version-valid.js    |  1 +
 .../browser/fixtures/version-valid.js.map     |  6 +++
 12 files changed, 108 insertions(+)
 create mode 100644 devtools/client/shared/source-map-loader/test/browser/browser_spec-source-map.js
 create mode 100644 devtools/client/shared/source-map-loader/test/browser/fixtures/source-map-spec-tests.json
 create mode 100644 devtools/client/shared/source-map-loader/test/browser/fixtures/version-not-a-number.js
 create mode 100644 devtools/client/shared/source-map-loader/test/browser/fixtures/version-not-a-number.js.map
 create mode 100644 devtools/client/shared/source-map-loader/test/browser/fixtures/version-numbers.js
 create mode 100644 devtools/client/shared/source-map-loader/test/browser/fixtures/version-too-high.js
 create mode 100644 devtools/client/shared/source-map-loader/test/browser/fixtures/version-too-high.js.map
 create mode 100644 devtools/client/shared/source-map-loader/test/browser/fixtures/version-too-low.js
 create mode 100644 devtools/client/shared/source-map-loader/test/browser/fixtures/version-too-low.js.map
 create mode 100644 devtools/client/shared/source-map-loader/test/browser/fixtures/version-valid.js
 create mode 100644 devtools/client/shared/source-map-loader/test/browser/fixtures/version-valid.js.map

diff --git a/devtools/client/shared/source-map-loader/test/browser/browser.toml b/devtools/client/shared/source-map-loader/test/browser/browser.toml
index 5a602e9eeb893..a670ab0acee89 100644
--- a/devtools/client/shared/source-map-loader/test/browser/browser.toml
+++ b/devtools/client/shared/source-map-loader/test/browser/browser.toml
@@ -19,3 +19,5 @@ skip-if = [
   "http3", # Bug 1829298
   "http2",
 ]
+
+["browser_spec-source-map.js"]
diff --git a/devtools/client/shared/source-map-loader/test/browser/browser_spec-source-map.js b/devtools/client/shared/source-map-loader/test/browser/browser_spec-source-map.js
new file mode 100644
index 0000000000000..4145268b8d542
--- /dev/null
+++ b/devtools/client/shared/source-map-loader/test/browser/browser_spec-source-map.js
@@ -0,0 +1,44 @@
+"use strict";
+
+async function isValidSourceMap(base) {
+  try {
+    await fetchFixtureSourceMap(base);
+  } catch (exn) {
+    return false;
+  }
+  return true;
+}
+
+const SPEC_TESTS_URI = `${URL_ROOT_SSL}fixtures/source-map-spec-tests.json`
+const testDescriptions = JSON.parse(read(SPEC_TESTS_URI));
+
+for (const testCase of testDescriptions.tests) {
+  async function testFunction() {
+      const baseName = testCase.baseFile.substring(0, testCase.baseFile.indexOf(".js"));
+      Assert.equal(testCase.sourceMapIsValid, await isValidSourceMap(baseName));
+  };
+  Object.defineProperty(testFunction, "name", { value: testCase.name });
+  add_task(testFunction);
+}
+
+function read(srcChromeURL) {
+  const scriptableStream = Cc[
+    "@mozilla.org/scriptableinputstream;1"
+  ].getService(Ci.nsIScriptableInputStream);
+
+  const channel = NetUtil.newChannel({
+    uri: srcChromeURL,
+    loadUsingSystemPrincipal: true,
+  });
+  const input = channel.open();
+  scriptableStream.init(input);
+
+  let data = "";
+  while (input.available()) {
+    data = data.concat(scriptableStream.read(input.available()));
+  }
+  scriptableStream.close();
+  input.close();
+
+  return data;
+}
diff --git a/devtools/client/shared/source-map-loader/test/browser/fixtures/source-map-spec-tests.json b/devtools/client/shared/source-map-loader/test/browser/fixtures/source-map-spec-tests.json
new file mode 100644
index 0000000000000..086f41ae34a35
--- /dev/null
+++ b/devtools/client/shared/source-map-loader/test/browser/fixtures/source-map-spec-tests.json
@@ -0,0 +1,28 @@
+{
+  "tests": [
+    {
+      "name": "versionValid",
+      "baseFile": "version-valid.js",
+      "sourceMapFile": "version-valid.js.map",
+      "sourceMapIsValid": true
+    },
+    {
+      "name": "versionNotANumber",
+      "baseFile": "version-not-a-number.js",
+      "sourceMapFile": "version-not-a-number.js.map",
+      "sourceMapIsValid": false
+    },
+    {
+      "name": "versionTooHigh",
+      "baseFile": "version-too-high.js",
+      "sourceMapFile": "version-too-high.js.map",
+      "sourceMapIsValid": false
+    },
+    {
+      "name": "versionTooLow",
+      "baseFile": "version-too-low.js",
+      "sourceMapFile": "version-too-low.js.map",
+      "sourceMapIsValid": false
+    }
+  ]
+}
diff --git a/devtools/client/shared/source-map-loader/test/browser/fixtures/version-not-a-number.js b/devtools/client/shared/source-map-loader/test/browser/fixtures/version-not-a-number.js
new file mode 100644
index 0000000000000..5382a716e3a21
--- /dev/null
+++ b/devtools/client/shared/source-map-loader/test/browser/fixtures/version-not-a-number.js
@@ -0,0 +1 @@
+// # sourceMappingURL=version-not-a-number.js.map
diff --git a/devtools/client/shared/source-map-loader/test/browser/fixtures/version-not-a-number.js.map b/devtools/client/shared/source-map-loader/test/browser/fixtures/version-not-a-number.js.map
new file mode 100644
index 0000000000000..a584d6e695117
--- /dev/null
+++ b/devtools/client/shared/source-map-loader/test/browser/fixtures/version-not-a-number.js.map
@@ -0,0 +1,6 @@
+{
+  "version" : "3foo",
+  "sources": [],
+  "names": [],
+  "mappings": ""
+}
diff --git a/devtools/client/shared/source-map-loader/test/browser/fixtures/version-numbers.js b/devtools/client/shared/source-map-loader/test/browser/fixtures/version-numbers.js
new file mode 100644
index 0000000000000..e79993b659db6
--- /dev/null
+++ b/devtools/client/shared/source-map-loader/test/browser/fixtures/version-numbers.js
@@ -0,0 +1,6 @@
+// Test that invalid version numbers are rejected.
+
+assert(isValidSourceMap("./version-valid.map"));
+assert(!isValidSourceMap("./version-not-a-number.map"));
+assert(!isValidSourceMap("./version-too-low.map"));
+assert(!isValidSourceMap("./version-too-high.map"));
diff --git a/devtools/client/shared/source-map-loader/test/browser/fixtures/version-too-high.js b/devtools/client/shared/source-map-loader/test/browser/fixtures/version-too-high.js
new file mode 100644
index 0000000000000..04bfe7f62b7b9
--- /dev/null
+++ b/devtools/client/shared/source-map-loader/test/browser/fixtures/version-too-high.js
@@ -0,0 +1 @@
+// # sourceMappingURL=version-too-high.js.map
diff --git a/devtools/client/shared/source-map-loader/test/browser/fixtures/version-too-high.js.map b/devtools/client/shared/source-map-loader/test/browser/fixtures/version-too-high.js.map
new file mode 100644
index 0000000000000..ee23be32ff278
--- /dev/null
+++ b/devtools/client/shared/source-map-loader/test/browser/fixtures/version-too-high.js.map
@@ -0,0 +1,6 @@
+{
+  "version" : 4,
+  "sources": [],
+  "names": [],
+  "mappings": ""
+}
diff --git a/devtools/client/shared/source-map-loader/test/browser/fixtures/version-too-low.js b/devtools/client/shared/source-map-loader/test/browser/fixtures/version-too-low.js
new file mode 100644
index 0000000000000..54b3526c6b5e2
--- /dev/null
+++ b/devtools/client/shared/source-map-loader/test/browser/fixtures/version-too-low.js
@@ -0,0 +1 @@
+// # sourceMappingURL=version-too-low.js.map
diff --git a/devtools/client/shared/source-map-loader/test/browser/fixtures/version-too-low.js.map b/devtools/client/shared/source-map-loader/test/browser/fixtures/version-too-low.js.map
new file mode 100644
index 0000000000000..64ca7a6e2e928
--- /dev/null
+++ b/devtools/client/shared/source-map-loader/test/browser/fixtures/version-too-low.js.map
@@ -0,0 +1,6 @@
+{
+  "version" : 2,
+  "sources": [],
+  "names": [],
+  "mappings": ""
+}
diff --git a/devtools/client/shared/source-map-loader/test/browser/fixtures/version-valid.js b/devtools/client/shared/source-map-loader/test/browser/fixtures/version-valid.js
new file mode 100644
index 0000000000000..f8541f9efdc71
--- /dev/null
+++ b/devtools/client/shared/source-map-loader/test/browser/fixtures/version-valid.js
@@ -0,0 +1 @@
+// # sourceMappingURL=version-valid.js.map
diff --git a/devtools/client/shared/source-map-loader/test/browser/fixtures/version-valid.js.map b/devtools/client/shared/source-map-loader/test/browser/fixtures/version-valid.js.map
new file mode 100644
index 0000000000000..1a163052d8fc8
--- /dev/null
+++ b/devtools/client/shared/source-map-loader/test/browser/fixtures/version-valid.js.map
@@ -0,0 +1,6 @@
+{
+  "version" : 3,
+  "sources": [],
+  "names": [],
+  "mappings": ""
+}
-- 
2.39.2

